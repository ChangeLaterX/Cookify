name: OCR Tests

on:
  push:
    paths:
      - 'backend/domains/ocr/**'
      - 'backend/tests/ocr/**'
      - 'data/**'
  pull_request:
    paths:
      - 'backend/domains/ocr/**'
      - 'backend/tests/ocr/**'
      - 'data/**'
  workflow_dispatch:
    inputs:
      test_mode:
        description: 'Test Mode'
        required: true
        default: 'all'
        type: choice
        options:
        - all
        - unit
        - integration
        - performance

env:
  PYTHON_VERSION: "3.10"

jobs:
  ocr-tests:
    name: OCR Tests
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        test-type: [unit, integration, performance]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          libmagic1 \
          libmagic-dev \
          tesseract-ocr \
          tesseract-ocr-deu \
          tesseract-ocr-eng \
          libtesseract-dev
    
    - name: Verify Tesseract installation
      run: |
        tesseract --version
        tesseract --list-langs
        which tesseract
    
    - name: Install Python dependencies
      working-directory: ./backend
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Set environment variables
      run: |
        echo "OCR_TEST_MOCK_MODE=false" >> $GITHUB_ENV
        echo "OCR_TEST_INTEGRATION=true" >> $GITHUB_ENV
        echo "TEST_ENVIRONMENT=ci" >> $GITHUB_ENV
        # CI-specific performance thresholds
        echo "OCR_TEST_MAX_AVG_LATENCY_MS=60000" >> $GITHUB_ENV
        echo "OCR_TEST_MAX_LATENCY_STD_DEV_MS=15000" >> $GITHUB_ENV
        echo "OCR_TEST_MAX_THROUGHPUT_TIME_S=180" >> $GITHUB_ENV
        echo "OCR_TEST_MAX_E2E_AVG_MS=90000" >> $GITHUB_ENV
        echo "OCR_TEST_MAX_E2E_MAX_MS=120000" >> $GITHUB_ENV
        echo "OCR_TEST_MAX_SCALABILITY_MS=75000" >> $GITHUB_ENV
        echo "OCR_TEST_MAX_MEMORY_GROWTH_MB=300" >> $GITHUB_ENV
        echo "OCR_TEST_MIN_THROUGHPUT_TPS=0.02" >> $GITHUB_ENV
    
    - name: Run OCR unit tests
      if: matrix.test-type == 'unit' || github.event.inputs.test_mode == 'all'
      working-directory: ./backend
      run: |
        pytest tests/ocr/unit/ \
          --tb=short \
          -v \
          --junitxml=test-results-ocr-unit.xml \
          --cov=domains.ocr \
          --cov-report=xml:coverage-ocr-unit.xml
    
    - name: Run OCR integration tests
      if: matrix.test-type == 'integration' || github.event.inputs.test_mode == 'all'
      working-directory: ./backend
      run: |
        pytest tests/ocr/integration/ \
          --tb=short \
          -v \
          --junitxml=test-results-ocr-integration.xml \
          --cov=domains.ocr \
          --cov-report=xml:coverage-ocr-integration.xml
    
    - name: Run OCR performance tests
      if: matrix.test-type == 'performance' || github.event.inputs.test_mode == 'all'
      working-directory: ./backend
      run: |
        pytest tests/ocr/ \
          -k "performance" \
          --tb=short \
          -v \
          --junitxml=test-results-ocr-performance.xml
    
    - name: Upload test results
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: ocr-test-results-${{ matrix.test-type }}
        path: |
          backend/test-results-ocr-*.xml
          backend/coverage-ocr-*.xml
    
    - name: Generate OCR test report
      if: always()
      working-directory: ./backend
      run: |
        echo "# OCR Test Results - ${{ matrix.test-type }}" > ocr-test-summary.md
        echo "" >> ocr-test-summary.md
        echo "## Environment" >> ocr-test-summary.md
        echo "- Python: $(python --version)" >> ocr-test-summary.md
        echo "- Tesseract: $(tesseract --version | head -1)" >> ocr-test-summary.md
        echo "- Test Type: ${{ matrix.test-type }}" >> ocr-test-summary.md
        echo "- Runner: ${{ runner.os }}" >> ocr-test-summary.md
        echo "" >> ocr-test-summary.md
        
        if [ -f test-results-ocr-${{ matrix.test-type }}.xml ]; then
          echo "## Test Results" >> ocr-test-summary.md
          echo "Test results available in XML format" >> ocr-test-summary.md
        fi
    
    - name: Upload test summary
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: ocr-test-summary-${{ matrix.test-type }}
        path: backend/ocr-test-summary.md

  ocr-docker-test:
    name: OCR Docker Test
    runs-on: ubuntu-latest
    needs: [ocr-tests]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: Build Docker image with OCR support
      working-directory: ./backend
      run: |
        docker build -t cookify-ocr:test .
    
    - name: Test OCR functionality in Docker
      working-directory: ./backend
      run: |
        # Start container
        docker run -d --name ocr-test-container \
          -e OCR_TEST_MOCK_MODE=false \
          -e OCR_TEST_INTEGRATION=true \
          -p 8000:8000 \
          cookify-ocr:test
        
        # Wait for startup
        sleep 15
        
        # Test OCR endpoint (if available)
        curl -f http://localhost:8000/health || exit 1
        
        # Run basic OCR test inside container
        docker exec ocr-test-container tesseract --version
        
        # Clean up
        docker stop ocr-test-container
        docker rm ocr-test-container
