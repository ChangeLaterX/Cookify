name: Backend API Tests

on:
  push:
    branches: [main, dev]
    paths:
      - 'backend/**'
      - '.github/workflows/backend-tests.yml'
  pull_request:
    branches: [main, dev]
    paths:
      - 'backend/**'
      - '.github/workflows/backend-tests.yml'
  workflow_dispatch:
    inputs:
      test_mode:
        description: 'Test mode to run'
        required: false
        default: 'full'
        type: choice
        options:
          - full
          - unit-only
          - security-only
          - endpoints-only

env:
  PYTHON_VERSION: "3.12.11"

jobs:
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    if: github.event.inputs.test_mode != 'security-only' && github.event.inputs.test_mode != 'endpoints-only'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y libmagic1 libmagic-dev tesseract-ocr tesseract-ocr-deu tesseract-ocr-eng libtesseract-dev
    
    - name: Cache Python dependencies
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
    
    - name: Install Python dependencies
      working-directory: ./backend
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest-json-report pytest-html pytest-cov pytest-xdist
    
    - name: Set up test environment
      working-directory: ./backend
      run: |
        echo "ENVIRONMENT=test" > .env.test
        echo "DEBUG=False" >> .env.test
        echo "SUPABASE_URL=${{ secrets.SUPABASE_URL }}" >> .env.test
        echo "SUPABASE_KEY=${{ secrets.SUPABASE_KEY }}" >> .env.test
        echo "JWT_SECRET=${{ secrets.JWT_SECRET }}" >> .env.test
        echo "JWT_ALGORITHM=HS256" >> .env.test
        echo "JWT_EXPIRATION=1440" >> .env.test
        echo "TEST_EMAIL=krijajannis@gmail.com" >> .env.test
        echo "TEST_PASSWORD=221224" >> .env.test
        echo "OCR_TEST_MOCK_MODE=false" >> .env.test
        echo "OCR_TEST_INTEGRATION=true" >> .env.test
        echo "DB_READ_ONLY=true" >> .env.test
    
    - name: Run unit tests
      working-directory: ./backend
      run: |
        pytest tests/ \
          --verbose \
          --tb=short \
          --cov=domains \
          --cov=core \
          --cov=middleware \
          --cov=shared \
          --cov-report=xml:coverage.xml \
          --cov-report=html:htmlcov \
          --cov-report=term-missing \
          --cov-fail-under=75 \
          --junitxml=test-results.xml \
          --json-report --json-report-file=test-report.json \
          --html=test-report.html --self-contained-html \
          --maxfail=5 \
          --durations=10
    
    - name: Generate test summary
      if: always()
      working-directory: ./backend
      run: |
        echo "## Test Results Summary" > test-summary.md
        if [ -f test-report.json ]; then
          echo "- Tests found in test-report.json" >> test-summary.md
        else
          echo "- No test report generated" >> test-summary.md
        fi
        if [ -f coverage.xml ]; then
          echo "- Coverage report generated" >> test-summary.md
        else
          echo "- No coverage report" >> test-summary.md
        fi
    
    - name: Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: unit-test-results
        path: |
          backend/test-results.xml
          backend/test-report.json
          backend/test-report.html
          backend/coverage.xml
          backend/htmlcov/
          backend/test-summary.md

  endpoint-tests:
    name: API Endpoint Tests
    runs-on: ubuntu-latest
    if: github.event.inputs.test_mode != 'unit-only' && github.event.inputs.test_mode != 'security-only'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: Install dependencies
      working-directory: ./backend
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install httpx pytest-asyncio
    
    - name: Create endpoint discovery script
      working-directory: ./backend
      run: |
        cat > discover_endpoints.py << 'EOF'
        import re
        import json
        from pathlib import Path

        def find_fastapi_routes():
            endpoints = []
            for py_file in Path('domains').rglob('*.py'):
                try:
                    with open(py_file, 'r') as f:
                        content = f.read()
                    patterns = [
                        r'@router\.(get|post|put|delete|patch)\s*\(\s*["\']([^"\'\s]+)["\']',
                        r'@app\.(get|post|put|delete|patch)\s*\(\s*["\']([^"\'\s]+)["\']'
                    ]
                    for pattern in patterns:
                        matches = re.findall(pattern, content)
                        for method, path in matches:
                            if not any(term in path.lower() for term in ['reset', 'forgot']):
                                endpoints.append({
                                    'method': method.upper(),
                                    'path': path,
                                    'file': str(py_file)
                                })
                except Exception as e:
                    print(f'Error reading {py_file}: {e}')
            
            print(f'Found {len(endpoints)} endpoints:')
            for ep in endpoints:
                print(f'  {ep["method"]} {ep["path"]}')
            
            with open('discovered_endpoints.json', 'w') as f:
                json.dump(endpoints, f)

        if __name__ == '__main__':
            find_fastapi_routes()
        EOF
        python3 discover_endpoints.py
    
    - name: Create endpoint tests
      working-directory: ./backend
      run: |
        cat > test_discovered_endpoints.py << 'EOF'
        import json
        import pytest
        from fastapi.testclient import TestClient
        from main import app

        try:
            with open("discovered_endpoints.json", "r") as f:
                ENDPOINTS = json.load(f)
        except FileNotFoundError:
            ENDPOINTS = []

        class TestDiscoveredEndpoints:
            
            @pytest.fixture(scope="class")
            def client(self):
                return TestClient(app)
            
            @pytest.fixture(scope="class")
            def auth_token(self, client):
                try:
                    response = client.post("/auth/login", json={
                        "email": "krijajannis@gmail.com",
                        "password": "221224"
                    })
                    if response.status_code == 200:
                        return response.json().get("access_token")
                except:
                    pass
                return None
            
            @pytest.mark.parametrize("endpoint", ENDPOINTS)
            def test_endpoint_responds(self, client, auth_token, endpoint):
                method = endpoint["method"]
                path = endpoint["path"]
                
                test_path = path.replace("{id}", "1").replace("{user_id}", "1")
                
                headers = {}
                if auth_token and ("auth" in path or "profile" in path or "me" in path):
                    headers["Authorization"] = f"Bearer {auth_token}"
                
                try:
                    if method == "GET":
                        response = client.get(test_path, headers=headers)
                    elif method == "POST":
                        response = client.post(test_path, json={}, headers=headers)
                    elif method == "PUT":
                        response = client.put(test_path, json={}, headers=headers)
                    elif method == "DELETE":
                        response = client.delete(test_path, headers=headers)
                    elif method == "PATCH":
                        response = client.patch(test_path, json={}, headers=headers)
                    else:
                        pytest.skip(f"Unsupported method: {method}")
                    
                    assert response.status_code != 404, f"Endpoint not found: {method} {path}"
                    assert response.status_code != 500, f"Server error: {method} {path}"
                    
                except Exception as e:
                    pytest.fail(f"Endpoint {method} {path} failed: {str(e)}")
            
            def test_health_endpoint_performance(self, client):
                import time
                start = time.time()
                response = client.get("/health")
                duration = (time.time() - start) * 1000
                
                assert duration < 1000, f"Health endpoint too slow: {duration:.2f}ms"
                assert response.status_code == 200
        EOF
    
    - name: Run endpoint tests
      working-directory: ./backend
      run: |
        if [ -f discovered_endpoints.json ]; then
          pytest test_discovered_endpoints.py -v --tb=short --junitxml=endpoint-results.xml
        else
          echo "No endpoints discovered, skipping tests"
        fi
    
    - name: Upload endpoint test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: endpoint-test-results
        path: |
          backend/endpoint-results.xml
          backend/discovered_endpoints.json
          backend/test_discovered_endpoints.py

  security-tests:
    name: Security Tests
    runs-on: ubuntu-latest
    if: github.event.inputs.test_mode != 'unit-only' && github.event.inputs.test_mode != 'endpoints-only'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: Install security tools
      run: |
        python -m pip install --upgrade pip
        pip install bandit safety pip-audit
    
    - name: Run Bandit security scan
      working-directory: ./backend
      run: |
        bandit -r domains/ core/ middleware/ shared/ \
          -f json -o bandit-report.json \
          --severity-level medium \
          --skip B101,B601 || true
        
        bandit -r domains/ core/ middleware/ shared/ \
          --severity-level medium \
          --skip B101,B601 || true
    
    - name: Run Safety dependency scan
      working-directory: ./backend
      run: |
        safety check --json --output safety-report.json || true
        safety check || true
    
    - name: Run pip-audit
      working-directory: ./backend
      run: |
        pip-audit --format=json --output=pip-audit-report.json || true
        pip-audit || true
    
    - name: Create security summary
      working-directory: ./backend
      run: |
        echo "## Security Scan Results" > security-summary.md
        echo "- Bandit scan completed" >> security-summary.md
        echo "- Safety scan completed" >> security-summary.md
        echo "- Pip-audit scan completed" >> security-summary.md
    
    - name: Upload security results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: security-scan-results
        path: |
          backend/bandit-report.json
          backend/safety-report.json
          backend/pip-audit-report.json
          backend/security-summary.md

  docker-tests:
    name: Docker Build Test
    runs-on: ubuntu-latest
    needs: [unit-tests]
    if: github.event.inputs.test_mode != 'unit-only' && github.event.inputs.test_mode != 'endpoints-only' && github.event.inputs.test_mode != 'security-only'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v4
    
    - name: Build Docker image
      working-directory: ./backend
      run: |
        docker build -t cookify-backend:test .
    
    - name: Test Docker container
      working-directory: ./backend
      run: |
        docker run -d --name test-container \
          -e ENVIRONMENT=test \
          -p 8000:8000 \
          cookify-backend:test
        
        sleep 10
        
        curl -f http://localhost:8000/health || exit 1
        
        docker logs test-container
        docker stop test-container
        docker rm test-container
    
    - name: Upload Docker results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: docker-test-results
        path: backend/docker-logs.txt

  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [unit-tests, endpoint-tests, security-tests, docker-tests]
    if: always()
    
    steps:
    - name: Download artifacts
      uses: actions/download-artifact@v4
    
    - name: Generate final report
      run: |
        echo "# Cookify Backend Test Report" > final-report.md
        echo "" >> final-report.md
        echo "**Run ID**: ${{ github.run_id }}" >> final-report.md
        echo "**Commit**: ${{ github.sha }}" >> final-report.md
        echo "**Branch**: ${{ github.ref_name }}" >> final-report.md
        echo "" >> final-report.md
        
        echo "## Test Results" >> final-report.md
        echo "| Test Suite | Status |" >> final-report.md
        echo "|------------|--------|" >> final-report.md
        echo "| Unit Tests | ${{ needs.unit-tests.result }} |" >> final-report.md
        echo "| Endpoint Tests | ${{ needs.endpoint-tests.result }} |" >> final-report.md
        echo "| Security Tests | ${{ needs.security-tests.result }} |" >> final-report.md
        echo "| Docker Tests | ${{ needs.docker-tests.result }} |" >> final-report.md
        
        if [[ "${{ needs.unit-tests.result }}" == "failure" || "${{ needs.endpoint-tests.result }}" == "failure" || "${{ needs.security-tests.result }}" == "failure" || "${{ needs.docker-tests.result }}" == "failure" ]]; then
          echo "## Overall Status: FAILED ❌" >> final-report.md
        else
          echo "## Overall Status: PASSED ✅" >> final-report.md
        fi
        
        cat final-report.md
    
    - name: Comment on PR
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const report = fs.readFileSync('final-report.md', 'utf8');
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: report
          });
    
    - name: Upload final report
      uses: actions/upload-artifact@v4
      with:
        name: final-test-report
        path: final-report.md
