version: '3.8'

services:
  cookify-api:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        - BUILDKIT_INLINE_CACHE=1
    image: cookify-api:latest
    container_name: cookify_api
    ports:
      - "8000:8000"
    env_file:
      - .env
    environment:
      # Supabase Configuration
      - SUPABASE_URL=${SUPABASE_URL:-}
      - SUPABASE_KEY=${SUPABASE_KEY:-}
      
      # FastAPI Configuration
      - DEBUG=${DEBUG:-false}
      - ENVIRONMENT=${ENVIRONMENT:-production}
      - APP_NAME=Cookify API
      - VERSION=1.0.0
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      
      # Security Settings
      - REQUIRE_EMAIL_VERIFICATION=${REQUIRE_EMAIL_VERIFICATION:-true}
      - ENABLE_USER_CACHE=${ENABLE_USER_CACHE:-true}
      - USER_CACHE_TTL_SECONDS=${USER_CACHE_TTL_SECONDS:-300}
      - SECURITY_HEADERS_ENABLED=${SECURITY_HEADERS_ENABLED:-true}
      
      # OCR Security Settings
      - OCR_MAX_IMAGE_SIZE_BYTES=${OCR_MAX_IMAGE_SIZE_BYTES:-5242880}  # 5MB
      - OCR_PROCESSING_TIMEOUT=${OCR_PROCESSING_TIMEOUT:-30}
      - RATE_LIMIT_OCR_ATTEMPTS=${RATE_LIMIT_OCR_ATTEMPTS:-10}
      - RATE_LIMIT_OCR_WINDOW_MINUTES=${RATE_LIMIT_OCR_WINDOW_MINUTES:-5}
      - RATE_LIMIT_OCR_EXTRACT_ATTEMPTS=${RATE_LIMIT_OCR_EXTRACT_ATTEMPTS:-5}
      - RATE_LIMIT_OCR_EXTRACT_WINDOW_MINUTES=${RATE_LIMIT_OCR_EXTRACT_WINDOW_MINUTES:-2}
      - RATE_LIMIT_OCR_ENABLE_PROGRESSIVE_DELAY=${RATE_LIMIT_OCR_ENABLE_PROGRESSIVE_DELAY:-true}
      
      # CORS Settings
      - CORS_ORIGINS=${CORS_ORIGINS:-["http://localhost:3000","http://localhost:5173"]}
      - ENABLE_TRUSTED_HOST_MIDDLEWARE=${ENABLE_TRUSTED_HOST_MIDDLEWARE:-true}
      - TRUSTED_HOSTS=${TRUSTED_HOSTS:-["localhost","127.0.0.1"]}
      
      # Session/Security
      - SESSION_HTTPS_ONLY=${SESSION_HTTPS_ONLY:-false}
      - ENABLE_ACCESS_LOG=${ENABLE_ACCESS_LOG:-true}
      
    restart: unless-stopped
    
    # Enhanced healthcheck configuration
    healthcheck:
      test: ["/backend/healthcheck.sh"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    
    # Network configuration
    networks:
      - cookify-network
    
    # Enhanced security configuration
    security_opt:
      - no-new-privileges:true
      - apparmor:unconfined  # May be needed for OCR processing
    
    # File system configuration
    read_only: false  # OCR needs to write temporary files
    tmpfs:
      - /tmp/ocr_secure:noexec,nosuid,nodev,size=80m,uid=1000,gid=1000
    
    # Volume mounts for persistence
    volumes:
      - app-logs:/backend/logs:rw
      - app-cache:/backend/.cache:rw
    
    # Resource limits optimized for dedicated server (1 CPU, 861MB RAM)
    deploy:
      resources:
        limits:
          memory: 750M  # Use most available RAM (leave ~110MB for system)
          cpus: '1.0'   # Use full CPU core
        reservations:
          memory: 300M  # Reserve more for stable operation
          cpus: '0.3'   # Reserve 30% of CPU
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
        window: 120s
    
    # Logging configuration
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        
    # Dependencies (if you add a database later)
    depends_on: []

# Network configuration
networks:
  cookify-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16

# Volume configuration for data persistence
volumes:
  app-logs:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ./logs
  app-cache:
    driver: local
